# Экономическая Модель: Партионный Учет (FIFO)

**Версия:** 2.0
**Статус:** Актуальная документация

---

## 1. Основные Принципы

Система использует метод **FIFO (First-In, First-Out)** для оценки запасов и расчета себестоимости.
*   Каждая закупка создает отдельную Партию (`Batch`) с фиксированной ценой входа.
*   При списании материалов система автоматически выбирает самые старые доступные партии.
*   Себестоимость готовой продукции рассчитывается как сумма фактических затрат на использованные партии сырья.

---

## 2. Алгоритм Расчета Себестоимости

### 2.1. Механизм Списания
При запросе на списание количества $Q_{req}$ система выполняет итерацию по активным партиям, отсортированным по дате создания (возрастание):

1.  Берется старейшая партия $i$.
2.  Из неё списывается максимально возможное количество: $Q_{taken} = \min(Q_{remaining\_i}, Q_{req})$.
3.  Стоимость этого "куска" добавляется к общей сумме: $Cost += Q_{taken} \times P_{price\_i}$.
4.  Остаток потребности уменьшается: $Q_{req} -= Q_{taken}$.
5.  Если потребность не закрыта, переход к следующей партии.

### 2.2. Итоговая Формула
Себестоимость использованного материала ($TotalCost$) рассчитывается как:

$$ TotalCost = \sum (Q_{batch} \times P_{batch}) $$

Где:
*   $Q_{batch}$ — количество, списанное с конкретной партии.
*   $P_{batch}$ — закупочная цена этой партии.

### 2.3. Пример Расчета
**На складе:**
*   Партия #1: 10 кг по 2000 ₸
*   Партия #2: 10 кг по 3000 ₸

**Списание 15 кг:**
1.  10 кг из Партии #1 $\rightarrow$ $10 \times 2000 = 20 000 ₸$
2.  5 кг из Партии #2 $\rightarrow$ $5 \times 3000 = 15 000 ₸$
3.  **Итого:** $35 000 ₸$ (Средняя цена списания: $2333.33 ₸/кг$)

---

## 3. Структура Данных

Для обеспечения финансовой прозрачности ("Traceability") результаты списания фиксируются в модели `ProductionMaterial`.

| Поле | Описание |
| :--- | :--- |
| `quantityUsed` | Фактически списанный вес. |
| `totalCost` | Точная сумма затрат в валюте системы. Является первичным источником для финансовых отчетов. |
| `priceAtMoment` | Расчетная цена за единицу в момент списания (`totalCost / quantityUsed`). |
| `details` | JSON-массив с детализацией источников: `[{ "batchId": "uuid", "qty": 10, "price": 2000 }, ...]`. |

---

## 4. Обработка Особых Ситуаций

### 4.1. Отрицательный Остаток (Deficit)
Если на складе недостаточно товара для полного покрытия потребности:
1.  Списываются все доступные партии.
2.  Оставшийся дефицит списывается "в минус" (общий остаток товара становится отрицательным).
3.  Стоимость дефицитной части рассчитывается по **цене последней закупки** (`Last Purchase Price`).
4.  В поле `details` добавляется запись с `batchId: null`.

### 4.2. Принудительный Выбор Партии
Если пользователь вручную указывает конкретную партию (`batchId`) при создании производства:
1.  Логика FIFO игнорируется.
2.  Списание происходит строго из указанной партии.
3.  В случае нехватки остатка в выбранной партии операция блокируется (ошибка валидации).

---

## 5. Жизненный Цикл Данных

1.  **Создание (Draft/In Progress):**
    *   Пользователь видит *прогнозную* себестоимость, основанную на текущих справочных ценах.
    *   В интерфейсе отображается пометка **(Прогноз)**.

2.  **Завершение (Completed):**
    *   Бэкенд выполняет транзакцию списания (`InventoryService.deductStock`).
    *   Рассчитывается и фиксируется финальная `totalCost`.
    *   Обновляется себестоимость готовой продукции (`ProductionItem`).
    *   Данные становятся неизменяемыми финансовыми фактами.
