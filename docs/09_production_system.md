# Система «Производство» (Production System)

Система предназначена для фиксации процесса переработки сырья в готовую продукцию с учетом партионного учета (Batch Tracking), временных затрат, изменения веса (усушки) и автоматического расчета себестоимости.

## 1. Флоу пользователя (User Flow)

1.  **Выбор Рецепта:** Оператор выбирает нужный рецепт. Рецепт определяет итоговый продукт и список ингредиентов.
2.  **Выбор Партий Сырья:** Для каждого основного ингредиента (Meat Base) оператор может выбрать конкретную **Партию** (Batch) со склада.
    *   Если партия выбрана: себестоимость считается по цене этой партии.
    *   Если выбрано «Автоматически»: система применит FIFO (First In, First Out) логику при списании.
3.  **Начальный вес:** Оператор вводит фактический вес замеса. 
4.  **Запуск процесса:** Нажатие «Начать производство» создает запись `IN_PROGRESS`. Остатки на складах не меняются.
5.  **Этапы (Timing):** Фиксация времени подготовки, сушки, копчения и варки.
6.  **Завершение:** 
    *   Ввод «Конечного веса».
    *   Расчет процента усушки: `((Initial - Final) / Initial) * 100`.
    *   Расчет себестоимости: `Total_Cost / Final_Weight`.
    *   Нажатие «Завершить и Списать» переводит статус в `COMPLETED`. В этот момент происходит физическое списание сырья и приход готовой продукции.

## 2. Логика Backend (Backend Logic)

### Алгоритм списания сырья (Deduction Logic)
При завершении производства система обрабатывает каждый ингредиент:
1.  **Если указана конкретная партия (`batchId`):**
    *   Уменьшается `remainingQuantity` в этой записи `Batch`.
    *   Уменьшается `currentStock` в таблице `Product`.
2.  **Если партия НЕ указана (FIFO Mode):**
    *   Система находит все активные партии этого товара (`remainingQuantity > 0`), отсортированные по дате создания (старые — первые).
    *   Последовательно списывает нужный вес, пока потребность не будет закрыта.
    *   Общий `currentStock` товара также уменьшается.

### Алгоритм прихода готовой продукции
1.  **Создание новой Партии:** Для каждого произведенного товара создается уникальная запись в таблице `Batch`.
    *   `initialQuantity` = `remainingQuantity` = Выпуск варки.
    *   `pricePerUnit` = Рассчитанная себестоимость.
    *   Связь: Партия ссылается на `ProductionItem`.
2.  **Обновление справочной цены:** `Product.averagePurchasePrice` обновляется по методу средневзвешенной цены для корректного отображения в общем списке.

## 3. Математические формулы

### Процент усушки (Loss Percentage)
$$L = \frac{W_{initial} - W_{final}}{W_{initial}} \times 100\%$$

### Себестоимость партии (Batch Cost)
$$C_{unit} = \frac{\sum (Quantity_{i} \times Price_{i})}{W_{final}}$$
Где $Quantity_{i}$ — вес $i$-го ингредиента, $Price_{i}$ — цена его партии.

## 4. Технологический стек
*   **Database:** PostgreSQL (через Prisma ORM).
*   **Logic Layer:** `ProductionService.ts` — содержит метод `processProductionCompletion`, работающий внутри ACID-транзакции.
*   **Types:** Строгая типизация через TypeScript для исключения ошибок в расчетах Decimal-чисел.