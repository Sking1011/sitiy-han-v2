datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  DIRECTOR
  OPERATOR
  ACCOUNTANT
}

enum CategoryType {
  STOCK
  EXPENSE
}

enum Unit {
  KG
  PIECE
  LITER
  PACK
}

enum ProcurementStatus {
  COMPLETED
  CANCELLED
}

enum ProductionStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

enum PaymentSource {
  BUSINESS_CASH
  PERSONAL_FUNDS
}

model User {
  id           String       @id @default(uuid())
  username     String       @unique
  name         String
  email        String?      @unique
  passwordHash String
  role         Role         @default(OPERATOR)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  productions  Production[]
  procurements Procurement[] @relation("UserProcurements")
  sales        Sale[]        @relation("UserSales")
  expenses     Expense[]     @relation("UserExpenses")
  disposals    Disposal[]
  merges       BatchMerge[]
  auditLogs    AuditLog[]
}

model Category {
  id       String       @id @default(uuid())
  name     String
  parentId String?
  parent   Category?    @relation("SubCategories", fields: [parentId], references: [id])
  children Category[]   @relation("SubCategories")
  type     CategoryType @default(STOCK)
  isFinished Boolean    @default(false) // True for Finished Goods categories
  color    String?      // HEX code
  products Product[]
  expenses Expense[]
}

model Product {
  id                   String                @id @default(uuid())
  categoryId           String
  category             Category              @relation(fields: [categoryId], references: [id])
  name                 String
  unit                 Unit
  minStock             Decimal               @default(0) @db.Decimal(10, 3)
  currentStock         Decimal               @default(0) @db.Decimal(10, 3)
  averagePurchasePrice Decimal               @default(0) @db.Decimal(10, 2)
  sellingPrice         Decimal               @default(0) @db.Decimal(10, 2) // Fixed selling price
  image                String?
  ingredients          RecipeIngredient[]
  procurementItems     ProcurementItem[]
  productionItems      ProductionItem[]
  productionMaterials  ProductionMaterial[]
  saleItems            SaleItem[]
  disposals            Disposal[]
  batches              Batch[]
  merges               BatchMerge[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

model Batch {
  id                String    @id @default(uuid())
  productId         String
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  procurementItemId String?   @unique
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])
  
  productionItemId  String?   @unique
  productionItem    ProductionItem? @relation(fields: [productionItemId], references: [id])
  
  initialQuantity   Decimal   @db.Decimal(10, 3)
  remainingQuantity Decimal   @db.Decimal(10, 3)
  pricePerUnit      Decimal   @db.Decimal(10, 2)
  
  productionMaterials ProductionMaterial[]
  disposals           Disposal[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model BatchMerge {
  id                String   @id @default(uuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  sourceInfo        String   // Описание исходной партии
  targetInfo        String   // Описание целевой партии
  targetBatchId     String
  
  quantityMerged    Decimal  @db.Decimal(10, 3)
  priceAtMerge      Decimal  @db.Decimal(10, 2)
  
  date              DateTime @default(now())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
}

model Recipe {
  id            String             @id @default(uuid())
  name          String
  description   String?
  ingredients   RecipeIngredient[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String
  recipe       Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Product @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  quantity     Decimal @db.Decimal(10, 3)
  isMain       Boolean @default(true)
}

model Procurement {
  id            String            @id @default(uuid())
  date          DateTime          @default(now())
  supplier      String?
  totalAmount   Decimal           @db.Decimal(12, 2)
  status        ProcurementStatus @default(COMPLETED)
  paymentSource PaymentSource     @default(BUSINESS_CASH)
  isExpensed    Boolean           @default(true)
  userId        String?
  user          User?             @relation("UserProcurements", fields: [userId], references: [id])
  items         ProcurementItem[]
  createdAt     DateTime          @default(now())
}

model ProcurementItem {
  id            String      @id @default(uuid())
  procurementId String
  procurement   Procurement @relation(fields: [procurementId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity      Decimal     @db.Decimal(10, 3)
  pricePerUnit  Decimal     @db.Decimal(10, 2)
  batch         Batch?
}

model Production {
  id            String               @id @default(uuid())
  date          DateTime             @default(now())
  status        ProductionStatus     @default(COMPLETED)
  note          String?
  performedBy   String
  performer     User                 @relation(fields: [performedBy], references: [id])
  items         ProductionItem[]
  materials     ProductionMaterial[]
  
  // Timing and Weights
  initialWeight Decimal?             @db.Decimal(10, 3)
  finalWeight   Decimal?             @db.Decimal(10, 3)
  prepTime      Int?                 // in minutes
  dryingTime    Int?                 // in minutes
  smokingTime   Int?                 // in minutes
  boilingTime   Int?                 // in minutes
  totalCost     Decimal?             @db.Decimal(12, 2)
}

model ProductionItem {
  id                    String     @id @default(uuid())
  productionId          String
  production            Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  productId             String
  product               Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantityProduced      Decimal    @db.Decimal(10, 3)
  calculatedCostPerUnit Decimal    @db.Decimal(10, 2)
  batch                 Batch?
}

model ProductionMaterial {
  id           String     @id @default(uuid())
  productionId String
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchId      String?
  batch        Batch?     @relation(fields: [batchId], references: [id])
  quantityUsed Decimal    @db.Decimal(10, 3)

  // Economic tracking
  priceAtMoment Decimal? @db.Decimal(10, 2) // Средняя цена списания за единицу
  totalCost     Decimal? @db.Decimal(12, 2) // Общая стоимость (сумма по партиям)
  details       String?                     // JSON с разбивкой по партиям: [{batchId, qty, price}, ...]
}

model Sale {
  id           String     @id @default(uuid())
  date         DateTime   @default(now())
  totalRevenue Decimal    @db.Decimal(12, 2)
  customer     String?
  userId       String?
  user         User?      @relation("UserSales", fields: [userId], references: [id])
  items        SaleItem[]
}

model SaleItem {
  id           String  @id @default(uuid())
  saleId       String
  sale         Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity     Decimal @db.Decimal(10, 3)
  pricePerUnit Decimal @db.Decimal(10, 2)
}

model Expense {
  id            String        @id @default(uuid())
  categoryId    String
  category      Category      @relation(fields: [categoryId], references: [id])
  name          String
  amount        Decimal       @db.Decimal(12, 2)
  paymentSource PaymentSource @default(BUSINESS_CASH)
  date          DateTime      @default(now())
  description   String?
  userId        String?
  user          User?         @relation("UserExpenses", fields: [userId], references: [id])
}

model SystemSetting {
  key         String  @id
  value       String
  description String?
}

model AuditLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  details   String?  // JSON or string details of the action
}

model Disposal {
  id           String   @id @default(uuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchId      String?
  batch        Batch?   @relation(fields: [batchId], references: [id])
  quantity     Decimal  @db.Decimal(10, 3)
  reason       String?
  date         DateTime @default(now())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  
  // Economic tracking
  totalCost    Decimal? @db.Decimal(12, 2) // Общая стоимость списания
  pricePerUnit Decimal? @db.Decimal(10, 2) // Цена за единицу (справочно)
  details      String?                     // JSON с разбивкой: [{batchId, qty, price}, ...]
}
