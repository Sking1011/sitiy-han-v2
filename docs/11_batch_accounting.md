# Попарный учет и Слияния (Batch Accounting & Merges)

Система Sitiy Han v2 использует строгий попарный учет для обеспечения максимальной точности себестоимости и финансовой прозрачности.

## 1. Концепция Партии (Batch)

**Партия** — это атомарная единица товара на складе. 
*   Каждый закуп (через модуль «Закупки») создает новую партию.
*   Каждый выпуск продукции (через модуль «Производство») создает новую партию.
*   Партия хранит: Дату, Поставщика/Исполнителя, Цену входа и **текущий остаток**.

### Преимущество перед "Общим остатком"
В классических системах остатки смешиваются. В Sitiy Han вы можете иметь две карточки одного и того же товара:
1. "Говядина" (Закуп 01.02) — 10кг по 1800 ₸.
2. "Говядина" (Закуп 10.02) — 50кг по 2100 ₸.
Это позволяет точно знать прибыль при использовании каждой конкретной партии.

## 2. Логика Слияния (Merge Logic)

Слияние необходимо для объединения мелких остатков или переноса веса между похожими товарами одной категории.

### Алгоритм слияния (Backend)
Слияние всегда происходит **В текущую партию** (Target).
1.  **Проверка:** Оба товара должны принадлежать одной категории.
2.  **Пересчет веса:** Вес из источника прибавляется к весу цели.
3.  **Пересчет себестоимости:** Используется формула средневзвешенной цены (Weighted Average).
4.  **Транзакционность:** 
    *   Создается запись в `BatchMerge` для аудита.
    *   Обновляется `Target Batch`.
    *   `Source Batch` либо уменьшается (частичное слияние), либо удаляется (полное слияние).
    *   Корректируются общие остатки в таблице `Product`, если товары разные.

### Математическая формула слияния
Новая цена принимающей партии рассчитывается как:
$$P_{target\_new} = \frac{(Q_{source} 	imes P_{source}) + (Q_{target\_old} 	imes P_{target\_old})}{Q_{source} + Q_{target\_old}}$$

Где:
*   $Q$ — количество (Remaining Quantity).
*   $P$ — цена за единицу (Price Per Unit).

## 3. Списание (Disposal)

Списание в партионном учете всегда **адресное**.
*   Если списание производится через карточку партии, вес уходит именно из `remainingQuantity` этой партии.
*   Это позволяет вести учет брака по каждой конкретной варке отдельно, не «размазывая» убытки по всему складу.

## 4. Слияние разных товаров (Cross-Product Merge)
Система поддерживает слияние разных SKU внутри одной категории (например, «Обрезь» -> «Фарш»). 
При таком слиянии:
1. Общий остаток (`currentStock`) первого товара уменьшается.
2. Общий остаток второго товара увеличивается.
3. Финансовая ценность (актив) предприятия остается неизменной, так как сумма стоимостей ($Q 	imes P$) сохраняется.
