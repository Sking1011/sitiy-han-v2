# Система «Производство» (Production System)

Система предназначена для фиксации процесса переработки сырья в готовую продукцию с учетом временных затрат, изменения веса (усушки) и автоматического расчета себестоимости.

## 1. Флоу пользователя (User Flow)

1.  **Выбор Рецепта:** Оператор выбирает нужный рецепт из выпадающего списка. Рецепт жестко определяет итоговый продукт и список ингредиентов.
2.  **Начальный вес:** Оператор вводит фактический начальный вес сырья (мяса/птицы), подготовленного к производству. 
3.  **Запуск процесса:** Нажатие кнопки «Начать производство» создает запись со статусом `IN_PROGRESS`. В этот момент складские остатки **не меняются**.
4.  **Этапы (Timing):** Оператор может фиксировать время подготовки, сушки, копчения и варки. Эти данные можно обновлять в процессе производства.
5.  **Завершение:** 
    *   Оператор вводит «Конечный вес» (готового продукта).
    *   Система рассчитывает процент усушки и итоговую себестоимость 1 кг.
    *   Нажатие «Завершить и Списать» переводит статус в `COMPLETED`.

## 2. Логика Backend (Server Actions & Services)

### Транзакционность и Склады
Все операции списания и прихода выполняются внутри одной БД-транзакции (`Prisma.$transaction`):
1.  **Списание ингредиентов:** При переходе в `COMPLETED` система берет список материалов из рецепта и уменьшает `currentStock` у соответствующих продуктов.
2.  **Приход готовой продукции:** Увеличивает `currentStock` итогового продукта на величину «Конечного веса».
3.  **Расчет себестоимости:**
    *   Суммируется стоимость всех ингредиентов (на основе их `averagePurchasePrice`).
    *   Итоговая сумма делится на «Конечный вес».
    *   Полученная цена записывается в `averagePurchasePrice` готового продукта, что позволяет использовать его как ингредиент в других рецептах с актуальной ценой.

### Статусы
*   `DRAFT`: Черновик (не используется в текущей версии UI).
*   `IN_PROGRESS`: Партия в работе. Данные можно редактировать. Списаний нет.
*   `COMPLETED`: Партия готова. Склады обновлены. Редактирование закрыто.

## 3. Особенности UI
*   **Слева направо:** Интерфейс разбит на 3 колонки (Рецепт -> Процесс -> Итоги).
*   **Граммы vs Кг:** Система автоматически распознает специи (по категориям) и предлагает вводить их в граммах, конвертируя в кг для базы данных.
*   **Авто-сумма:** Показывает «Расчетную массу» всех компонентов для сверки с «Фактической массой».
